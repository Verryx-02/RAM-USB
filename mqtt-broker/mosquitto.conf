# Mosquitto MQTT Broker Configuration for R.A.M.-U.S.B. Monitoring System
#
# Security Architecture:
# - TLS 1.3 enforced for all connections
# - Certificate-based authentication (mTLS)
# - Topic-based ACL for publisher/subscriber isolation
# - Zero-knowledge (no user data in metrics)
#
# This configuration file uses placeholder paths that will be replaced
# by setup.sh based on the operating system.

# ===========================
# NETWORK CONFIGURATION
# ===========================

# TLS-only listener on port 8883
# No unencrypted connections allowed
listener 8883
protocol mqtt

# ===========================
# TLS/SSL CONFIGURATION
# ===========================

# Enforce TLS 1.3 for maximum security
# Prevents downgrade attacks and ensures modern cryptography
tls_version tlsv1.3

# Certificate Authority for validating client certificates
# All clients (publishers and subscribers) must present certificates
# signed by this CA
cafile /Users/francescoverrengia/Desktop/OpenSource/ram-usb/certificates/certification-authority/ca.crt

# MQTT Broker server certificate and private key
# Used for server authentication during TLS handshake
certfile /Users/francescoverrengia/Desktop/OpenSource/ram-usb/certificates/mqtt-broker/server.crt
keyfile /Users/francescoverrengia/Desktop/OpenSource/ram-usb/certificates/mqtt-broker/server.key

# Require client certificates for authentication
# No password-based authentication allowed
require_certificate true

# Use certificate Common Name (CN) as username
# Enables ACL rules based on certificate identity
# Example: CN=entry-hub-mqtt-publisher
use_identity_as_username true

# ===========================
# ACCESS CONTROL LIST (ACL)
# ===========================

# Enable topic-based access control
# Publishers can only write to their specific topics
# Subscriber can only read from metrics/* topics
acl_file /usr/local/etc/mosquitto/config/acl.conf

# Disable anonymous access
# All connections must present valid certificates
allow_anonymous false

# ===========================
# PERSISTENCE
# ===========================

# Enable message persistence for reliability
# Messages are saved to disk and survive broker restarts
persistence true

# Persistence database location
# Stores retained messages and subscriptions
persistence_location /usr/local/var/lib/mosquitto/

# Autosave interval in seconds
# Write in-memory database to disk every 60 seconds
autosave_interval 60

# ===========================
# LOGGING
# ===========================

# Log to file for audit trail and debugging
log_dest file /usr/local/var/log/mosquitto/mosquitto.log

# Also log to stdout for container environments
log_dest stdout

# Log levels for security monitoring
log_type error      # Critical errors that require attention
log_type warning    # Potential issues or misconfigurations
log_type notice     # Important operational messages
log_type information # General informational messages

# Enable connection logging for security audit
# Logs all connection attempts with certificate details
connection_messages true

# Add timestamp to all log entries
log_timestamp true

# Log message format with ISO 8601 timestamps
log_timestamp_format %Y-%m-%dT%H:%M:%S

# ===========================
# PERFORMANCE & LIMITS
# ===========================

# Maximum concurrent client connections
# Adjust based on number of services (Entry-Hub, Security-Switch, 
# Database-Vault, Metrics-Collector)
max_connections 100

# Maximum queued messages per client
# Prevents memory exhaustion from slow consumers
max_queued_messages 1000

# Maximum QoS level
# QoS 1 (at-least-once delivery) is sufficient for metrics
max_qos 1

# Message size limit (bytes)
# Prevent excessively large metric payloads
max_packet_size 10240

# ===========================
# SECURITY HARDENING
# ===========================

# Disable automatic client ID generation
# Forces clients to provide explicit IDs for tracking
allow_zero_length_clientid false

# Disable retained messages
# Metrics are time-series data, no need for retention
retain_available false

# Disable wildcard subscriptions for publish
# Prevents accidental or malicious broadcast
max_topic_alias 0

# ===========================
# PROTOCOL RESTRICTIONS
# ===========================

# Disable WebSockets
# Only MQTT protocol needed for service-to-service communication
# websockets_listener 0

# Disable MQTT bridge
# No external brokers in this architecture
# bridge_protocol_version mqttv311

# ===========================
# DEVELOPMENT NOTES
# ===========================
#
# For production deployment:
# 1. Update max_connections based on service count
# 2. Configure log rotation for /usr/local/var/log/mosquitto/mosquitto.log
# 3. Set up monitoring alerts for connection failures
# 4. Review ACL rules periodically
# 5. Keep TLS certificates updated before expiration
#
# For testing without TLS (NOT RECOMMENDED):
# - Add: listener 1883
# - Add: allow_anonymous true
# - Remove these settings before production!

# ===========================
# END OF CONFIGURATION
# ===========================